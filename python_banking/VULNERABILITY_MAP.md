# Python Banking - Vulnerability Map

## Visual Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Flask App (app.py)                       │
│                         8 Entry Points                           │
└─────────────────────────────────────────────────────────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│  Validation   │       │    Admin      │       │    Legacy     │
│   Service     │       │   Service     │       │   Service     │
│ (validators)  │       │ (protected)   │       │ (dead code)   │
└───────────────┘       └───────────────┘       └───────────────┘
        │                         │                         │
        ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Database Service                            │
│              Template Service (Sink Layer)                       │
│                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │cursor.execute│  │render_template│  │cursor.execute│          │
│  │   (VULN 1)  │  │  _string      │  │  (VULN 2-8) │          │
│  │  must_fix   │  │  (VULN 4-5-7) │  │    mixed    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## Vulnerability Flow Map

### TRUE POSITIVES (2)

```
VULN 1: SQL Injection (must_fix)
┌──────────────────────────────────────────────────────┐
│ GET /api/search?query=<injection>                    │
│   ↓                                                   │
│ search_transactions()                                 │
│   ↓                                                   │
│ db_service.search_transactions_vulnerable()           │
│   ↓                                                   │
│ cursor.execute(f"SELECT...{search_term}")  ← SINK    │
│                                                       │
│ ❌ NO PROTECTION                                      │
└──────────────────────────────────────────────────────┘

VULN 4: Template Injection (good_to_fix)
┌──────────────────────────────────────────────────────┐
│ POST /api/render/custom {"template": "<inject>"}     │
│   ↓                                                   │
│ render_custom_template()                              │
│   ↓                                                   │
│ validation_service.check_template_safety()  ← WEAK   │
│   ↓                                                   │
│ template_service.render_user_template()               │
│   ↓                                                   │
│ render_template_string(template_str)  ← SINK          │
│                                                       │
│ ⚠️  WEAK PROTECTION (can be bypassed)                │
└──────────────────────────────────────────────────────┘
```

### FALSE POSITIVES - SANITIZED (2)

```
VULN 2: SQL Injection (false_positive_sanitized)
┌──────────────────────────────────────────────────────┐
│ GET /api/user/profile?user_id=123                     │
│   ↓                                                   │
│ get_user_profile()                                    │
│   ↓                                                   │
│ validation_service.validate_user_id()  ← STRICT      │
│   │  re.fullmatch(r'^[0-9]+$')                       │
│   ↓                                                   │
│ db_service.get_user_by_id_with_validation()           │
│   ↓                                                   │
│ cursor.execute(f"SELECT...{validated_id}")  ← SINK   │
│                                                       │
│ ✅ PROTECTED by strict validation                     │
└──────────────────────────────────────────────────────┘

VULN 3: SQL Injection (false_positive_sanitized)
┌──────────────────────────────────────────────────────┐
│ POST /api/report/generate {"report_type": "..."}     │
│   ↓                                                   │
│ generate_report()                                     │
│   ↓                                                   │
│ db_service.generate_report_parameterized()            │
│   ↓                                                   │
│ cursor.execute(query, (filter, type))  ← SINK        │
│   Parameterized query!                                │
│                                                       │
│ ✅ PROTECTED by parameterized queries                 │
└──────────────────────────────────────────────────────┘
```

### FALSE POSITIVES - PROTECTED (3)

```
VULN 5: Template Injection (false_positive_protected)
┌──────────────────────────────────────────────────────┐
│ GET /api/user/preferences?key=theme                   │
│   @login_required  ← AUTH CHECK                       │
│   ↓                                                   │
│ get_preferences()                                     │
│   │  Check session['user_id']                        │
│   ↓                                                   │
│ template_service.render_preference_template()         │
│   │  User-scoped data only                           │
│   ↓                                                   │
│ render_template_string(template_str)  ← SINK          │
│                                                       │
│ ✅ PROTECTED by authentication + user scope           │
└──────────────────────────────────────────────────────┘

VULN 6: SQL Injection (false_positive_protected)
┌──────────────────────────────────────────────────────┐
│ GET /api/admin/audit?date=2024-01                     │
│   @admin_required  ← AUTH + AUTHZ CHECK               │
│   ↓                                                   │
│ admin_audit_logs()                                    │
│   │  Check session['role'] == 'admin'                │
│   ↓                                                   │
│ admin_service.get_audit_logs()                        │
│   ↓                                                   │
│ db_service.get_audit_logs_by_date()                   │
│   ↓                                                   │
│ cursor.execute(f"SELECT...{date_filter}")  ← SINK    │
│                                                       │
│ ✅ PROTECTED by admin authorization                   │
└──────────────────────────────────────────────────────┘

VULN 7: Template Injection (false_positive_protected)
┌──────────────────────────────────────────────────────┐
│ POST /api/admin/template/preview {"content": "..."}  │
│   @admin_required  ← Layer 1: ADMIN AUTH              │
│   ↓                                                   │
│ admin_template_preview()                              │
│   ↓                                                   │
│ admin_service.preview_template()                      │
│   ├─ Layer 2: Rate limiting                          │
│   ├─ Layer 3: Length restriction                     │
│   ↓                                                   │
│ template_service.render_admin_preview()               │
│   ├─ Layer 4: Content sanitization                   │
│   ├─ Layer 5: Remove template markers                │
│   ↓                                                   │
│ render_template_string(template_str)  ← SINK          │
│   ↓                                                   │
│   └─ Layer 6: Output filtering                       │
│                                                       │
│ ✅ PROTECTED by 6-layer defense-in-depth              │
└──────────────────────────────────────────────────────┘
```

### FALSE POSITIVES - DEAD CODE (1)

```
VULN 8: SQL Injection (false_positive_dead_code)
┌──────────────────────────────────────────────────────┐
│ POST /api/legacy/import {"data": "..."}              │
│   ↓                                                   │
│ legacy_import_data()                                  │
│   ↓                                                   │
│ legacy_service.process_legacy_import()                │
│   ↓                                                   │
│   if legacy_mode_enabled:  ← ALWAYS FALSE            │
│     │                                                 │
│     ├─ DEAD CODE BRANCH ─────────────────┐           │
│     │                                     │           │
│     ↓                                     │           │
│     execute_legacy_query()  ← UNREACHABLE│           │
│     │                                     │           │
│     ↓                                     │           │
│     db_service.execute_legacy_query()     │           │
│     │                                     │           │
│     ↓                                     │           │
│     cursor.execute(f"INSERT...")  ← SINK │           │
│     │                                     │           │
│     └─────────────────────────────────────┘           │
│   else:                                               │
│     ↓                                                 │
│     _process_modern_import()  ← LIVE CODE             │
│     (Safe processing)                                 │
│                                                       │
│ ✅ PROTECTED by unreachable code branch               │
└──────────────────────────────────────────────────────┘
```

## Summary Stats

```
┌────────────────────────────────────────────────────────┐
│  VULNERABILITY DISTRIBUTION                            │
├────────────────────────────────────────────────────────┤
│  Total Sinks:                              8           │
│                                                        │
│  TRUE POSITIVES:                           2  (25%)    │
│    └─ must_fix:                            1           │
│    └─ good_to_fix:                         1           │
│                                                        │
│  FALSE POSITIVES:                          6  (75%)    │
│    └─ Sanitized (validation):              1           │
│    └─ Sanitized (parameterized):           1           │
│    └─ Protected (auth):                    1           │
│    └─ Protected (admin):                   1           │
│    └─ Protected (defense-in-depth):        1           │
│    └─ Dead code:                           1           │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│  SINK PATTERN USAGE                                    │
├────────────────────────────────────────────────────────┤
│  cursor.execute(query):                    6  (75%)    │
│  render_template_string(template):         3  (37.5%)  │
│  Total unique sinks:                       8           │
└────────────────────────────────────────────────────────┘
```

## Attack Path Complexity

```
Hops   Vulnerabilities
═══════════════════════
 2     None
 3     VULN 1, 2, 3, 8      (Simple paths)
 4     VULN 4, 5, 6         (Medium complexity)
 5     VULN 7               (Defense-in-depth)

Average: 3.6 hops
```

## Files Structure

```
python_banking/
│
├── app.py                          ← 8 Flask routes (entry points)
│
├── services/
│   ├── database_service.py         ← 6 cursor.execute() sinks
│   ├── template_service.py         ← 3 render_template_string() sinks
│   ├── validation_service.py       ← Strict & weak validators
│   ├── admin_service.py            ← Admin-protected logic
│   └── legacy_service.py           ← Dead code examples
│
├── models/
│   └── user.py                     ← Safe ORM examples
│
├── utils/
│   └── security.py                 ← Security helpers
│
└── Documentation/
    ├── VULNERABILITY_TESTING_GUIDE.md   ← Detailed analysis
    ├── QUICK_REFERENCE.md               ← Summary table
    ├── IMPLEMENTATION_SUMMARY.md        ← Build summary
    └── VULNERABILITY_MAP.md             ← This file
```

## Expected Analyzer Output

```json
{
  "total_findings": 8,
  "classifications": {
    "must_fix": 1,
    "good_to_fix": 1,
    "false_positive_sanitized": 2,
    "false_positive_protected": 3,
    "false_positive_dead_code": 1
  },
  "accuracy": "100%",
  "confidence_avg": 0.88
}
```

---

**Status**: ✅ **Implementation Complete and Ready for Testing**
